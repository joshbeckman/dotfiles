#!/usr/bin/env bash
#
# github-wrapped - Generate GitHub year-in-review stats as markdown
#
# Usage: github-wrapped [year] [username]
#   year     - The year to generate stats for (default: current year)
#   username - GitHub username (default: from git config)
#
# Requires: gh CLI authenticated

set -euo pipefail

show_help() {
    cat << 'EOF'
github-wrapped - Generate GitHub year-in-review stats as markdown

USAGE:
    github-wrapped [year] [username]
    github-wrapped --help

ARGUMENTS:
    year        The year to generate stats for (default: current year)
    username    GitHub username (default: from git config or gh auth)

REQUIREMENTS:
    - gh CLI authenticated (run 'gh auth login' if needed)
    - jq for JSON parsing

DATA SOURCE:
    This tool uses GitHub's GraphQL API contributionsCollection endpoint,
    which provides the same data shown on your GitHub profile's contribution
    graph. This includes:

    - Commits to default/gh-pages branches (not forks unless merged upstream)
    - Opening issues and pull requests
    - Reviewing pull requests
    - Creating repositories

    IMPORTANT: By default, only PUBLIC repository contributions are included
    in the detailed breakdowns (languages, repositories). Private contribution
    counts are shown separately but without details.

    For more info: https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-profile/managing-contribution-settings-on-your-profile

EXAMPLES:
    github-wrapped                  # Current year, your username
    github-wrapped 2024             # Specific year
    github-wrapped 2024 octocat     # Specific year and user
    github-wrapped 2025 | preview-md  # Preview as rendered markdown

OUTPUT:
    Markdown-formatted stats including:
    - Contribution summary (commits, PRs, issues, reviews)
    - Activity patterns (busiest day, streaks, active days)
    - Top languages and repositories by commits
    - Profile stats (stars, followers)
EOF
}

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

YEAR="${1:-$(date +%Y)}"
USERNAME="${2:-$(gh api user --jq .login 2>/dev/null || git config github.user)}"

if [[ -z "$USERNAME" ]]; then
    echo "Error: Could not determine GitHub username" >&2
    echo "Usage: github-wrapped [year] [username]" >&2
    exit 1
fi

START_DATE="${YEAR}-01-01T00:00:00Z"
END_DATE="${YEAR}-12-31T23:59:59Z"

# Fetch data to stderr so it doesn't pollute markdown output
echo "Fetching contribution data..." >&2

# Get contribution calendar data
CONTRIB_DATA=$(gh api graphql -f query='
query($username: String!, $from: DateTime!, $to: DateTime!) {
  user(login: $username) {
    contributionsCollection(from: $from, to: $to) {
      totalCommitContributions
      totalIssueContributions
      totalPullRequestContributions
      totalPullRequestReviewContributions
      totalRepositoryContributions
      restrictedContributionsCount
      contributionCalendar {
        totalContributions
        weeks {
          contributionDays {
            contributionCount
            date
            weekday
          }
        }
      }
      commitContributionsByRepository(maxRepositories: 100) {
        repository {
          nameWithOwner
          primaryLanguage {
            name
          }
        }
        contributions {
          totalCount
        }
      }
    }
  }
}' -f username="$USERNAME" -f from="$START_DATE" -f to="$END_DATE" 2>/dev/null)

if [[ -z "$CONTRIB_DATA" ]] || echo "$CONTRIB_DATA" | jq -e '.errors' >/dev/null 2>&1; then
    echo "Error: Failed to fetch contribution data. Make sure you're authenticated with 'gh auth login'" >&2
    exit 1
fi

# Get stars/followers data
STAR_DATA=$(gh api graphql -f query='
query($username: String!) {
  user(login: $username) {
    repositories(first: 100, ownerAffiliations: OWNER, orderBy: {field: STARGAZERS, direction: DESC}) {
      nodes {
        name
        stargazerCount
      }
      totalCount
    }
    followers {
      totalCount
    }
    following {
      totalCount
    }
  }
}' -f username="$USERNAME" 2>/dev/null)

# Extract all stats
TOTAL_CONTRIBUTIONS=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.contributionCalendar.totalContributions')
TOTAL_COMMITS=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.totalCommitContributions')
TOTAL_ISSUES=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.totalIssueContributions')
TOTAL_PRS=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.totalPullRequestContributions')
TOTAL_REVIEWS=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.totalPullRequestReviewContributions')
TOTAL_NEW_REPOS=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.totalRepositoryContributions')
PRIVATE_CONTRIBS=$(echo "$CONTRIB_DATA" | jq '.data.user.contributionsCollection.restrictedContributionsCount')

TOTAL_STARS=$(echo "$STAR_DATA" | jq '[.data.user.repositories.nodes[].stargazerCount] | add // 0')
FOLLOWERS=$(echo "$STAR_DATA" | jq '.data.user.followers.totalCount')
FOLLOWING=$(echo "$STAR_DATA" | jq '.data.user.following.totalCount')
REPO_COUNT=$(echo "$STAR_DATA" | jq '.data.user.repositories.totalCount')

# Calculate busiest day
DAYS=("Sunday" "Monday" "Tuesday" "Wednesday" "Thursday" "Friday" "Saturday")
DAY_TOTALS=$(echo "$CONTRIB_DATA" | jq -r '
  .data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[] |
  "\(.weekday) \(.contributionCount)"
' | awk '{days[$1] += $2} END {for (d in days) print d, days[d]}' | sort -n)

MAX_DAY=""
MAX_COUNT=0
while read -r day count; do
    if [[ $count -gt $MAX_COUNT ]]; then
        MAX_COUNT=$count
        MAX_DAY="${DAYS[$day]}"
    fi
done <<< "$DAY_TOTALS"

# Streak analysis
STREAK_INFO=$(echo "$CONTRIB_DATA" | jq -r '
  [.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[] |
   {date: .date, count: .contributionCount}] |
  reduce .[] as $day (
    {current: 0, max: 0, maxStart: "", maxEnd: "", currentStart: ""};
    if $day.count > 0 then
      if .current == 0 then .currentStart = $day.date else . end |
      .current += 1 |
      if .current > .max then
        .max = .current | .maxStart = .currentStart | .maxEnd = $day.date
      else . end
    else .current = 0 end
  ) |
  "\(.max)|\(.maxStart)|\(.maxEnd)"
')
LONGEST_STREAK=$(echo "$STREAK_INFO" | cut -d'|' -f1)
STREAK_START=$(echo "$STREAK_INFO" | cut -d'|' -f2)
STREAK_END=$(echo "$STREAK_INFO" | cut -d'|' -f3)

ACTIVE_DAYS=$(echo "$CONTRIB_DATA" | jq '[.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[] | select(.contributionCount > 0)] | length')
TOTAL_DAYS=$(echo "$CONTRIB_DATA" | jq '[.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[]] | length')
ACTIVE_PCT=$(echo "scale=1; $ACTIVE_DAYS * 100 / $TOTAL_DAYS" | bc)

# Peak day
PEAK_INFO=$(echo "$CONTRIB_DATA" | jq -r '
  [.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[]] |
  max_by(.contributionCount) |
  "\(.date)|\(.contributionCount)"
')
PEAK_DATE=$(echo "$PEAK_INFO" | cut -d'|' -f1)
PEAK_COUNT=$(echo "$PEAK_INFO" | cut -d'|' -f2)

# Output markdown
cat << EOF
# GitHub Wrapped $YEAR

**[@$USERNAME](https://github.com/$USERNAME)**

## Contribution Summary

| Metric | Count |
|--------|-------|
| Total contributions | **$TOTAL_CONTRIBUTIONS** |
| Commits | $TOTAL_COMMITS |
| Pull requests | $TOTAL_PRS |
| PR reviews | $TOTAL_REVIEWS |
| Issues opened | $TOTAL_ISSUES |
| New repositories | $TOTAL_NEW_REPOS |
EOF

if [[ "$PRIVATE_CONTRIBS" != "0" ]]; then
    echo "| Private contributions | +$PRIVATE_CONTRIBS |"
fi

cat << EOF

## Activity Patterns

- **Busiest day of week:** $MAX_DAY ($MAX_COUNT contributions)
- **Longest streak:** $LONGEST_STREAK days ($STREAK_START to $STREAK_END)
- **Active days:** $ACTIVE_DAYS / $TOTAL_DAYS ($ACTIVE_PCT%)
- **Peak day:** $PEAK_DATE with $PEAK_COUNT contributions

## Activity by Day of Week

\`\`\`
EOF

# Scale bars to max 40 characters
MAX_BAR_WIDTH=40
DAY_MAX=$(echo "$DAY_TOTALS" | awk '{if ($2 > max) max = $2} END {print max}')
echo "$DAY_TOTALS" | while read -r day count; do
    DAY_NAME="${DAYS[$day]}"
    BAR_LEN=$((count * MAX_BAR_WIDTH / DAY_MAX))
    [[ $BAR_LEN -lt 1 ]] && BAR_LEN=1
    BAR=$(printf '█%.0s' $(seq 1 $BAR_LEN))
    printf "%-10s %4d %s\n" "$DAY_NAME" "$count" "$BAR"
done

cat << EOF
\`\`\`

## Monthly Breakdown

\`\`\`
EOF

MONTH_DATA=$(echo "$CONTRIB_DATA" | jq -r '
  [.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[] |
   {month: (.date | split("-")[1]), count: .contributionCount}] |
  group_by(.month) |
  map({month: .[0].month, total: (map(.count) | add)}) |
  sort_by(.month) |
  .[] |
  "\(.month)\t\(.total)"
')
MONTH_MAX=$(echo "$MONTH_DATA" | cut -f2 | sort -n | tail -1)
echo "$MONTH_DATA" | while IFS=$'\t' read -r month count; do
    MONTH_NAMES=("" "Jan" "Feb" "Mar" "Apr" "May" "Jun" "Jul" "Aug" "Sep" "Oct" "Nov" "Dec")
    MONTH_NAME="${MONTH_NAMES[${month#0}]}"
    BAR_LEN=$((count * MAX_BAR_WIDTH / MONTH_MAX))
    [[ $BAR_LEN -lt 1 ]] && BAR_LEN=1
    BAR=$(printf '█%.0s' $(seq 1 $BAR_LEN))
    printf "%-4s %4d %s\n" "$MONTH_NAME" "$count" "$BAR"
done

cat << EOF
\`\`\`

## Top Languages (by commits)

| Language | Commits |
|----------|---------|
EOF

echo "$CONTRIB_DATA" | jq -r '
  [.data.user.contributionsCollection.commitContributionsByRepository[] |
   select(.repository.primaryLanguage != null) |
   {lang: .repository.primaryLanguage.name, count: .contributions.totalCount}] |
  group_by(.lang) |
  map({lang: .[0].lang, total: (map(.count) | add)}) |
  sort_by(-.total) |
  .[:10][] |
  "| \(.lang) | \(.total) |"
'

cat << EOF

## Top Repositories (by commits)

| Repository | Commits |
|------------|---------|
EOF

echo "$CONTRIB_DATA" | jq -r '
  .data.user.contributionsCollection.commitContributionsByRepository |
  sort_by(-.contributions.totalCount) |
  .[:10][] |
  "| [\(.repository.nameWithOwner)](https://github.com/\(.repository.nameWithOwner)) | \(.contributions.totalCount) |"
'

cat << EOF

## Profile Stats

| Metric | Count |
|--------|-------|
| Total stars (all repos) | $TOTAL_STARS |
| Public repositories | $REPO_COUNT |
| Followers | $FOLLOWERS |
| Following | $FOLLOWING |

---

*Generated with [github-wrapped](https://github.com/$USERNAME/dotfiles/blob/master/bin/github-wrapped)*
EOF
